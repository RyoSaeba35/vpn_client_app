import 'dart:ffi';
import 'dart:io';
import 'package:ffi/ffi.dart';
import 'package:path/path.dart' as path;

typedef StartVpnFunc = Int32 Function(Pointer<Utf8> configPath);
typedef StartVpn = int Function(Pointer<Utf8> configPath);

typedef StopVpnFunc = Void Function();
typedef StopVpn = void Function();

DynamicLibrary _openSingBoxLibrary() {
  if (Platform.isAndroid) {
    return DynamicLibrary.open("libsingbox_wrapper.so");
  } else if (Platform.isLinux) {
    return DynamicLibrary.open("libsingbox.so");
  } else if (Platform.isMacOS) {
    return DynamicLibrary.open("libsingbox.dylib");
  } else if (Platform.isWindows) {
    final exeDir = path.dirname(Platform.resolvedExecutable);
    final arch = sizeOf<IntPtr>() == 8 ? 'x64' : 'x86';
    final dllPath = path.join(exeDir, 'libsingbox_$arch.dll');
    if (!File(dllPath).existsSync()) {
      throw Exception('libsingbox_$arch.dll not found at $dllPath');
    }
    return DynamicLibrary.open(dllPath);
  }
  throw UnsupportedError("This platform is not supported by sing-box FFI.");
}

final DynamicLibrary singboxLib = _openSingBoxLibrary();

final StartVpn startVPN = singboxLib.lookupFunction<StartVpnFunc, StartVpn>('Java_com_example_vpn_1client_1app_SingBoxWrapper_startVPN');
final StopVpn stopVPN = singboxLib.lookupFunction<StopVpnFunc, StopVpn>('Java_com_example_vpn_1client_1app_SingBoxWrapper_stopVPN');
